# 테이블 컬럼 정리 문서

## 1. outcome_raw (원본 outcomes 보존용)

| 컬럼명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| id | BIGSERIAL | Primary Key | |
| nct_id | VARCHAR(20) | Study ID | NOT NULL |
| outcome_type | VARCHAR(10) | PRIMARY 또는 SECONDARY | NOT NULL, CHECK |
| outcome_order | INTEGER | Outcome 순서 | NOT NULL |
| measure_raw | TEXT | 원본 measure 텍스트 | |
| description_raw | TEXT | 원본 description 텍스트 | |
| time_frame_raw | TEXT | 원본 time frame 텍스트 | |
| phase | VARCHAR(50) | Phase 정보 | PHASE1, PHASE2, PHASE3, PHASE4, NA 등 |
| source_version | VARCHAR(50) | 데이터 소스 버전 | |
| raw_json | JSONB | 원본 outcome JSON | |
| ingested_at | TIMESTAMP | 수집 시간 | DEFAULT CURRENT_TIMESTAMP |

**UNIQUE 제약**: (nct_id, outcome_type, outcome_order)

---

## 2. outcome_normalized (정규화된 outcomes)

| 컬럼명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| outcome_id | BIGSERIAL | Primary Key | |
| nct_id | VARCHAR(20) | Study ID | NOT NULL |
| outcome_type | VARCHAR(10) | PRIMARY 또는 SECONDARY | NOT NULL, CHECK |
| outcome_order | INTEGER | Outcome 순서 | NOT NULL |
| measure_raw | TEXT | 원본 measure 텍스트 | outcome_raw에서 복사 |
| measure_clean | TEXT | 클리닝된 measure 텍스트 | |
| measure_abbreviation | TEXT | 추출된 약어 | 괄호 안 약어 |
| measure_norm | VARCHAR(200) | 정규화된 measure 이름 | Dictionary의 canonical_name |
| measure_code | VARCHAR(50) | Measure 코드 | FK → outcome_measure_dict |
| match_type | VARCHAR(20) | 매칭 타입 | MEASURE_CODE, ABBREVIATION, KEYWORD, CANONICAL_NAME |
| match_keyword | TEXT | 매칭에 사용된 키워드 | |
| domain | VARCHAR(100) | Domain 정보 | Dictionary에서 가져옴 |
| time_frame_raw | TEXT | 원본 time frame 텍스트 | outcome_raw에서 복사 |
| time_value_main | NUMERIC | 추출된 시간 값 | |
| time_unit_main | VARCHAR(20) | 추출된 시간 단위 | day, week, month, year 등 |
| time_points | JSONB | 복수 시점 정보 | [{"value": 12, "unit": "week"}, ...] |
| time_phase | VARCHAR(50) | Time phase 정보 | double-blind, extension, follow-up 등 |
| phase | VARCHAR(50) | Phase 정보 | PHASE1, PHASE2, PHASE3, PHASE4, NA 등 |
| change_from_baseline_flag | BOOLEAN | Baseline 변경 플래그 | DEFAULT FALSE |
| description_raw | TEXT | 원본 description 텍스트 | outcome_raw에서 복사 |
| description_norm | TEXT | 정규화된 description | (현재 미사용) |
| failure_reason | VARCHAR(50) | 실패 원인 | MEASURE_CODE_FAILED, TIMEFRAME_FAILED, BOTH_FAILED, NULL(성공) |
| parsing_method | VARCHAR(20) | 파싱 방법 | RULE_BASED, LLM (DEFAULT: RULE_BASED) |
| num_arms | INTEGER | Study의 arm 개수 | (현재 NULL, 나중에 업데이트 가능) |
| created_at | TIMESTAMP | 생성 시간 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 수정 시간 | DEFAULT CURRENT_TIMESTAMP, 트리거로 자동 갱신 |

**Foreign Key**: measure_code → outcome_measure_dict(measure_code)

---

## 3. outcome_normalized_success (완벽 정규화된 데이터)

`LIKE outcome_normalized INCLUDING ALL`로 생성되므로 outcome_normalized와 동일한 컬럼 구조

**필터 조건**: `measure_code IS NOT NULL AND failure_reason IS NULL`

---

## 4. outcome_normalized_failed (정규화 실패 데이터)

`LIKE outcome_normalized INCLUDING ALL`로 생성되므로 outcome_normalized와 동일한 컬럼 구조

**필터 조건**: `measure_code IS NULL OR failure_reason IS NOT NULL`

---

## 5. intervention_raw (원본 intervention 정보)

| 컬럼명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| id | BIGSERIAL | Primary Key | |
| nct_id | VARCHAR(20) | Study ID | NOT NULL |
| intervention_order | INTEGER | Intervention 순서 | NOT NULL |
| type | VARCHAR(50) | Intervention 타입 | DRUG, BIOMARKER, DEVICE 등 |
| name | TEXT | Intervention 이름 | |
| description | TEXT | Intervention 설명 | |
| arm_group_labels | JSONB | armGroupLabels 배열 | ["Arm 1", "Arm 2"] |
| raw_json | JSONB | 원본 intervention JSON | |
| ingested_at | TIMESTAMP | 수집 시간 | DEFAULT CURRENT_TIMESTAMP |

**UNIQUE 제약**: (nct_id, intervention_order)

---

## 6. study_party_raw (기관/담당자 정보)

| 컬럼명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| id | BIGSERIAL | Primary Key | |
| nct_id | VARCHAR(20) | Study ID | NOT NULL |
| party_type | VARCHAR(20) | Party 타입 | LEAD_SPONSOR, ORGANIZATION, OFFICIAL |
| name_raw | TEXT | 이름 | |
| affiliation_raw | TEXT | 소속 | |
| role_raw | VARCHAR(100) | 역할 | |
| class_raw | VARCHAR(50) | 분류 | INDUSTRY, NIH 등 |
| location_raw | JSONB | 위치 정보 | |
| source_path | TEXT | 소스 경로 | |
| ingested_at | TIMESTAMP | 수집 시간 | DEFAULT CURRENT_TIMESTAMP |

**UNIQUE 제약**: (nct_id, party_type, name_raw)

---

## 7. outcome_measure_dict (Measure 사전)

| 컬럼명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| measure_code | VARCHAR(50) | Primary Key | |
| canonical_name | TEXT | 정식 이름 | NOT NULL |
| abbreviation | VARCHAR(100) | 약어 | |
| keywords | TEXT | 키워드 리스트 | 세미콜론으로 구분 |
| domain | VARCHAR(100) | Domain | |
| unit_type | VARCHAR(50) | 단위 타입 | |
| score_direction | VARCHAR(100) | 점수 방향 | Higher = worse, Higher = better 등 |
| created_at | TIMESTAMP | 생성 시간 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 수정 시간 | DEFAULT CURRENT_TIMESTAMP, 트리거로 자동 갱신 |

---

## 수정 사항

1. ✅ `outcome_normalized`의 `num_arms` 컬럼이 INSERT문에 추가됨 (NULL로 설정)
2. ✅ `intervention_raw` 테이블 정상 작동 확인
3. ✅ 모든 테이블 컬럼 일관성 확인 완료


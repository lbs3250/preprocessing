# 정규화 시스템 개선 작업 내역

**작업 일자**: 2024년  
**작업 목적**: Outcome 정규화 로직 고도화 및 Phase 정보 추가

---

## 📋 목차

1. [약어 추출 로직 개선](#1-약어-추출-로직-개선)
2. [Measure 매칭 로직 개선](#2-measure-매칭-로직-개선)
3. [Time Frame 정규화 개선](#3-time-frame-정규화-개선)
4. [사전 데이터 확장](#4-사전-데이터-확장)
5. [Phase 정보 추가](#5-phase-정보-추가)
6. [SQL 쿼리 개선](#6-sql-쿼리-개선)

---

## 1. 약어 추출 로직 개선

### 1.1 괄호 전후 모두 확인

**문제점:**

- 기존: 괄호 안의 텍스트만 약어로 추출
- 예: "changes in CDR (Clinical Dementia Rate)" → 괄호 안 "Clinical Dementia Rate"만 확인

**개선 사항:**

- 괄호 전 텍스트도 약어로 확인
- 괄호 전 마지막 단어만 약어로 추출 (전체 텍스트가 아닌)
- 예: "changes in CDR (Clinical Dementia Rate)" → "CDR" 추출

**코드 위치:** `normalize_phase1.py` (1054-1107줄)

```python
# 괄호 전 텍스트에서 마지막 단어만 추출
before_words = before_text_full.split()
before_text = before_words[-1] if before_words else None

# 괄호 전 마지막 단어가 약어인지 확인
if before_text and measure_patterns.is_valid_abbreviation(before_text):
    measure_abbreviation = f"({before_text})"
```

### 1.2 약어 초기화 문제 수정

**문제점:**

- 배치 처리 시 이전 배치의 `measure_abbreviation` 값이 남아있음
- 괄호가 없는 경우에도 이전 값이 들어가는 문제

**개선 사항:**

- 각 row 처리 시작 시 명시적으로 초기화
- `measure_abbreviation = None`
- `abbrev_candidates = []`

**코드 위치:** `normalize_phase1.py` (1047-1049줄)

---

## 2. Measure 매칭 로직 개선

### 2.1 매칭 우선순위 재정리

**기존 순서:**

1. 약어 추출 및 매칭
2. measure_code 직접 매칭
3. canonical_name 매칭
4. keywords 매칭

**개선된 순서:**

1. **0순위**: measure_code 직접 매칭 (가장 우선순위)
2. **1순위**: abbreviation 매칭 (약어 추출 및 Dictionary 매칭)
3. **2순위**: canonical_name 매칭 (완전 일치 + 부분 포함)
4. **3순위**: keywords 매칭 (완전 일치 + 부분 포함)
5. **4순위**: description_raw에서 매칭 시도 (모든 단계 실패 시)

**코드 위치:** `normalize_phase1.py` (1116-1359줄)

### 2.2 부분 매칭 추가

#### canonical_name 부분 매칭

- 사전의 `canonical_name`이 `measure_clean`에 포함되어 있으면 매칭
- 최소 5자 이상만 매칭 (너무 짧은 경우 제외)

#### keywords 부분 매칭

- 사전의 `keywords`가 `measure_clean`에 포함되어 있으면 매칭
- 단어 경계(`\b`)를 고려하여 정확한 매칭
- 최소 3자 이상만 매칭
- 원본 텍스트에서 단어 경계 확인 (정규화 전)

**예시:**

- "Change in CSF AD Biomarkers" → "CSF", "AD" 키워드 매칭 성공
- "changes in CDR (Clinical Dementia Rate)" → "CDR" 매칭 성공

**코드 위치:** `normalize_phase1.py` (1184-1257줄)

### 2.3 description_raw 매칭 추가

**추가 사항:**

- `measure_clean`에서 매칭 실패 시 `description_raw`에서도 사전 매칭 시도
- 동일한 매칭 로직 적용 (measure_code, canonical_name, keywords)
- 약어 추출은 하지 않음 (measure에서만 약어 추출)

**코드 위치:** `normalize_phase1.py` (1260-1359줄)

---

## 3. Time Frame 정규화 개선

### 3.1 Baseline 처리 개선

**추가 사항:**

- baseline만 있고 숫자나 단위가 없는 경우 → `0 day`로 처리
- 예: "baseline", "Baseline", "These measurements will be taken at baseline"

**코드 위치:** `normalize_phase1.py` (119-136줄, 743-760줄)

### 3.2 단위 변환 추가

**추가된 단위:**

- `wk`, `W` → `week`로 변환
- 예: "Wk 50", "W24", "4 wk" → 모두 `week`로 처리

**코드 위치:** `normalize_phase1.py` (124-148줄)

### 3.3 하이픈 포함 패턴 처리

**추가된 패턴:**

- "8-weeks", "6-week", "1-month", "3-month" 등
- 하이픈이 있어도 정상적으로 파싱

**코드 위치:** `normalize_phase1.py` (293줄, 341줄, 830줄)

### 3.4 서수 패턴 처리

**추가된 패턴:**

- "6th month", "8th week" 등
- 서수 접미사(`th`, `st`, `nd`, `rd`) 제거 후 숫자 추출

**코드 위치:** `normalize_phase1.py` (293줄, 792줄)

### 3.5 문자형 숫자 패턴 개선

**추가된 패턴:**

- "A year" → 1 year
- "year three" → 3 year
- "YEAR ONE" → 1 year
- "one-year" → 1 year
- "30 minutes", "24 months" 등 복수형 처리

**코드 위치:** `normalize_phase1.py` (818-828줄)

### 3.6 복수 시점 패턴 개선

**개선 사항:**

- `wk`, `W` 단위도 복수 시점 패턴에 포함
- 예: "Wk 50, W24" → 정상 파싱

**코드 위치:** `normalize_phase1.py` (164-185줄)

---

## 4. 사전 데이터 확장

### 4.1 ADAS-Cog 관련 약어 추가

**추가된 약어:**

- `adas-cog11` (ADAS-Cog11)
- `adas-cog-11` (ADAS-Cog-11)
- `adas-cog14` (ADAS-Cog14)
- `adas-cog-14` (ADAS-Cog-14)
- `adas-cog-13` (ADAS-Cog-13)
- `adas-cog13` (ADAS-Cog13)
- `adas` (ADAS, ADAs)
- `adas-cog` (ADAS-Cog)

**적용 방법:**

- `outcome_measure_dict` 테이블의 `ADAS_COG` 항목의 `keywords` 필드에 추가
- 스크립트: `add_adas_abbreviations.py`

**최종 keywords:**

```
adascog;adas-cog11;adas-cog-11;adas-cog11;adas-cog14;adas-cog-14;adas-cog14;adas-cog-13;adas-cog13;adas;adas-cog
```

---

## 5. Phase 정보 추가

### 5.1 데이터 수집 단계

**추가 사항:**

- `collect_outcomes.py`에 `extract_phase()` 함수 추가
- `protocolSection.designModule.phases`에서 phase 정보 추출
- 여러 phase가 있으면 쉼표로 구분하여 저장
- phase 정보가 없으면 'NA'로 저장

**코드 위치:** `collect_outcomes.py` (74-93줄)

### 5.2 스키마 수정

**추가된 컬럼:**

- `outcome_raw.phase VARCHAR(50)`
- `outcome_normalized.phase VARCHAR(50)`

**마이그레이션 스크립트:** `update_schema_add_phase.sql`

### 5.3 정규화 단계

**추가 사항:**

- `normalize_phase1.py`에서 `outcome_raw`의 `phase` 정보를 `outcome_normalized`로 복사
- NULL 값은 'NA'로 통일

**코드 위치:** `normalize_phase1.py` (1311줄)

### 5.4 통계 쿼리

**추가된 쿼리:**

- `query_phase_statistics.sql`: Phase별 통계 조회
  - Phase별 데이터 개수
  - Phase별 성공/실패률 (TimeFrame, Measure Code)
  - Phase NA 제외한 전체 통계

---

## 6. SQL 쿼리 개선

### 6.1 Sponsor 성공률 쿼리 개선

**파일:** `query_sponsor_success_rate.sql`

#### 추가된 컬럼:

1. **`study_count`**: Study 단위 총 개수 (중복 제거)

   ```sql
   COUNT(DISTINCT n.nct_id) as study_count
   ```

2. **`study_failed_count`**: 실패한 outcome이 하나라도 있는 study 개수

   ```sql
   COUNT(DISTINCT CASE WHEN n.failure_reason IS NOT NULL THEN n.nct_id END) as study_failed_count
   ```

3. **`study_failure_rate_percent`**: Study 기준 실패율
   ```sql
   ROUND(COUNT(DISTINCT CASE WHEN n.failure_reason IS NOT NULL THEN n.nct_id END)::numeric / COUNT(DISTINCT n.nct_id) * 100, 2) as study_failure_rate_percent
   ```

#### 필터 추가:

- Phase가 'NA'인 데이터 제외
  ```sql
  AND COALESCE(n.phase, 'NA') != 'NA'
  ```

#### 새로운 쿼리 추가:

- **실패율 높은 상위 50개 기관의 실패한 데이터 상세 조회**
  - CTE를 사용하여 상위 50개 기관 선정
  - 선정된 기관의 실패한 outcome 상세 정보 조회
  - 기관 정보, 실패율, outcome 상세 정보 포함

**코드 위치:** `query_sponsor_success_rate.sql` (55-120줄)

---

## 📊 주요 개선 효과

### 1. 약어 추출 정확도 향상

- 괄호 전후 모두 확인하여 매칭률 향상
- "CDR (Clinical Dementia Rate)" 같은 패턴 정상 처리

### 2. Measure 매칭률 향상

- 부분 매칭 추가로 매칭률 향상
- description_raw에서도 매칭 시도하여 추가 매칭 기회 제공
- 단어 경계 고려로 정확도 향상

### 3. Time Frame 파싱 커버리지 확대

- 다양한 패턴 지원 (하이픈, 서수, 문자형 숫자 등)
- baseline 처리 개선
- 단위 변환 추가 (wk, W → week)

### 4. 사전 데이터 확장

- ADAS-Cog 관련 약어 추가로 매칭률 향상
- 다양한 변형 지원 (ADAS-Cog11, ADAS-Cog-13 등)

### 5. Phase 정보 추가

- Phase별 통계 분석 가능
- Phase별 데이터 표기 방식 차이 분석 가능

### 6. 통계 쿼리 개선

- Outcome 단위와 Study 단위 통계 모두 제공
- 실패율 높은 기관의 상세 분석 가능

---

## 🔧 기술적 세부사항

### 정규식 패턴 개선

#### Time Frame 패턴

- 하이픈 포함: `\d+\s*-?\s*(week|weeks|...)`
- 서수 패턴: `(\d+)(?:th|st|nd|rd)?\s+(month|months|...)`
- 단위+숫자: `(wk|w)\s+(\d+)`

#### Measure 매칭 패턴

- 단어 경계: `\b키워드\b`
- 정규화: 소문자 변환, 공백/하이픈/언더스코어 제거

### 매칭 로직 흐름

```
1. 약어 추출 (괄호 전후 확인)
   ↓
2. 0순위: measure_code 직접 매칭
   ↓ 실패 시
3. 1순위: abbreviation 매칭
   ↓ 실패 시
4. 2순위: canonical_name 매칭 (완전 일치 + 부분 포함)
   ↓ 실패 시
5. 3순위: keywords 매칭 (완전 일치 + 부분 포함, 단어 경계 고려)
   ↓ 실패 시
6. 4순위: description_raw에서 매칭 시도 (동일한 로직)
```

---

## 📝 파일 변경 내역

### 수정된 파일

1. `normalize_phase1.py` - 정규화 로직 전반 개선
2. `collect_outcomes.py` - Phase 정보 추출 추가
3. `schema.sql` - Phase 컬럼 추가
4. `update_schema_add_phase.sql` - Phase 컬럼 마이그레이션 스크립트
5. `separate_normalized_data.py` - Phase 인덱스 추가
6. `query_sponsor_success_rate.sql` - 통계 쿼리 개선
7. `query_phase_statistics.sql` - Phase 통계 쿼리 추가

### 새로 생성된 파일

1. `add_adas_abbreviations.py` - ADAS-Cog 약어 추가 스크립트
2. `add_adas_abbreviations.sql` - ADAS-Cog 약어 추가 SQL
3. `remove_added_abbreviations.py` - 잘못 추가된 약어 제거 스크립트 (삭제됨)

---

## ✅ 다음 단계 권장 사항

1. **정규화 재실행**

   - 개선된 로직으로 전체 데이터 재정규화
   - Phase 정보 포함하여 수집 및 정규화

2. **사전 데이터 확장**

   - 자주 실패하는 measure_abbreviation 분석
   - 필요한 약어 추가

3. **정규식 패턴 추가 검증**

   - 다양한 패턴에 대한 테스트 케이스 작성
   - Edge case 처리 확인

4. **성능 최적화**
   - 대용량 데이터 처리 시 성능 모니터링
   - 인덱스 최적화 검토

---

## 📚 참고 문서

- `정규식_패턴_가이드.md` - Time Frame 정규식 패턴 상세 가이드
- `query_phase_statistics.sql` - Phase별 통계 쿼리
- `query_sponsor_success_rate.sql` - Sponsor별 성공률 쿼리

